<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Mobile-Friendly Meta Tags -->
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>TEDPOLE - Mobile Chat</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    /* Global Styles */
    body {
      font-family: Arial, sans-serif;
      background-color: #fcfafa;
      margin: 0;
      padding: 0;
      transition: background-color 0.5s ease;
    }
    /* Authentication Section */
    .center-section {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #000;
      padding: 15px;
    }
    .container-custom {
      background: rgba(0,0,0,0.15);
      padding: 40px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      border-radius: 8px;
      transition: all 0.5s ease;
    }
    .app-name {
      font-size: 24px;
      color: #4a90e2;
      font-weight: bold;
      margin-bottom: 20px;
      text-align: center;
    }
    /* Name Row: First & Last Name side-by-side */
    .name-row .form-control {
      padding: 10px;
      border-radius: 8px;
      background: #2e3446;
      color: white;
      border: none;
      transition: box-shadow 0.3s ease;
    }
    .name-row .form-control::placeholder {
      color: #b0b3c4;
    }
    .name-row .form-control:focus {
      box-shadow: 0 0 5px 2px rgba(74,144,226,0.6);
    }
    /* Standard Form Styles */
    .form-control {
      background: #2e3446;
      border: none;
      color: white;
      border-radius: 8px;
      padding: 10px 40px;
      transition: box-shadow 0.3s ease;
    }
    .form-control:focus {
      box-shadow: 0 0 5px 2px rgba(74,144,226,0.6);
    }
    .form-control::placeholder {
      color: #b0b3c4;
    }
    .btn-primary {
      background: #4a90e2;
      border: none;
      border-radius: 8px;
      padding: 10px;
      font-weight: bold;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    .btn-primary:hover {
      background: #357abd;
      transform: scale(1.03);
    }
    .toggle-link {
      color: #4a90e2;
      text-decoration: none;
      font-size: 0.9rem;
      transition: color 0.3s ease;
    }
    .toggle-link:hover {
      color: #357abd;
    }
    .password-container {
      position: relative;
    }
    .password-container .bi {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #b0b3c4;
      cursor: pointer;
    }
    .input-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #b0b3c4;
    }
    .code-timer {
      color: #ff4d4d;
      font-weight: bold;
      margin-left: 10px;
    }
    .code-input-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.5s;
    }
    /* Welcome Message */
    #welcome {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(to right, rgba(18,53,255,0.48), #151044);
      color: rgb(255, 255, 255);
      text-align: center;
      display: none;
      padding: 15px;
    }
    #appContent {
      display: none;
      color: #000000;
    }
    /* Navbar */
    .navbar {
      background-color: #0400ff !important;
    }
    .navbar-brand, .nav-link {
      color: #ffffff !important;
    }
    .nav-link:hover {
      color: #4a90e2 !important;
    }
    /* Features Section */
    #features {
      padding: 60px 0;
    }
    .feature-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .feature-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    }
    /* Camera Section */
    #camera {
      background: #000;
      min-height: 100vh;
      padding-top: 60px;
      position: relative;
      display: none;
      animation: fadeIn 0.5s;
    }
    #camera-preview {
      width: 100%;
      max-width: 600px;
      margin: 20px auto;
      display: block;
      border: 5px solid #fff;
      border-radius: 8px;
    }
    .capture-button {
      font-size: 24px;
      cursor: pointer;
      text-align: center;
      margin: 20px auto;
      transition: transform 0.2s ease;
    }
    .capture-button:hover {
      transform: scale(1.1);
    }
    .return-button {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 2rem;
      color: #fff;
      cursor: pointer;
      transition: transform 0.3s ease, color 0.3s ease;
    }
    .return-button:hover {
      color: #ccc;
      transform: rotate(-10deg);
    }
    /* Chat Section */
    #chat {
      min-height: 100vh;
      background: #f8f9fa;
      color: #000;
      display: none;
      animation: fadeIn 0.5s;
      position: relative;
      overflow: hidden;
    }
    #chat-list-view {
      padding: 10px;
      overflow-y: auto;
      height: calc(100vh - 60px);
    }
    .chat-list-item {
      background: #fff;
      padding: 10px;
      margin-bottom: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .chat-list-item:hover {
      background: #f0f0f0;
    }
    #chat-detail-view {
      display: none;
      height: 100vh;
      position: relative;
    }
    #chat-detail-top-bar {
      background: #fff;
      border-bottom: 1px solid #ccc;
      padding: 5px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    #chat-detail-left {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    /* Removed the 9 dots (grid icon) from top-left as requested */
    #back-icon {
      font-size: 1.5rem;
      cursor: pointer;
      margin-left: 5px;
    }
    #opponent-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    #opponent-name {
      font-size: 1.1rem;
      font-weight: bold;
      margin-left: 5px;
    }
    #chat-detail-right {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }
    #voice-call, #video-call, #more-options {
      font-size: 1.5rem;
      cursor: pointer;
    }
    #moreOptionsMenu {
      position: absolute;
      top: 40px;
      right: 0;
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: none;
      z-index: 999;
    }
    #moreOptionsMenu ul {
      list-style: none;
      margin: 0;
      padding: 5px;
    }
    #moreOptionsMenu li {
      padding: 5px 10px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    #moreOptionsMenu li:hover {
      background: #eee;
    }
    #detail-chat-messages-container {
      background-size: cover;
      height: calc(100vh - 130px);
      overflow-y: auto;
      padding: 10px;
    }
    #no-messages-placeholder {
      text-align: center;
      margin-top: 50px;
      color: #777;
    }
    #no-messages-placeholder img {
      max-width: 150px;
      border-radius: 10px;
      opacity: 0.8;
    }
    #chat-messages {
      margin-top: 10px;
    }
    .chat-message {
      background: #4a90e2;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      margin-bottom: 5px;
      max-width: 70%;
      word-wrap: break-word;
    }
    .file-message {
      background: #333;
      color: #ffffff;
      padding: 5px 10px;
      border-radius: 5px;
      margin-bottom: 5px;
      max-width: 70%;
      word-wrap: break-word;
    }
    #chat-input-area {
      background: #fff;
      border-top: 1px solid #ccc;
      padding: 5px 10px;
      position: absolute;
      bottom: 0;
      width: 100%;
    }
    #chat-input-area .input-group {
      flex-wrap: nowrap;
    }
    .attach-menu {
      position: absolute;
      bottom: 60px;
      right: 10px;
      background: #ffffff;
      border: 1px solid #000000;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgb(255, 208, 208);
      display: none;
      z-index: 999;
    }
    .attach-menu ul {
      list-style: none;
      margin: 0;
      padding: 5px;
    }
    .attach-menu li {
      padding: 5px 10px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .attach-menu li:hover {
      background: #ffffff;
    }
    @media (max-width: 576px) {
      #chat-search { width: 100px; }
      #back-icon, #voice-call, #video-call, #more-options, .chat-top-icon, #account-icon { font-size: 1.3rem; }
      #detail-chat-messages-container { height: calc(100vh - 120px); }
    }
  </style>
</head>
<body>
  <!-- Authentication Section -->
  <div id="auth-section" class="center-section">
    <!-- Sign Up Container -->
    <div class="container-custom fade-in" id="signup-container">
      <div class="app-name">TEDPOLE</div>
      <form id="signup-form" class="needs-validation" novalidate>
        <!-- First & Last Name side-by-side -->
        <div class="row mb-3 name-row">
          <div class="col">
            <input type="text" class="form-control" id="first-name" placeholder="First Name" required>
          </div>
          <div class="col">
            <input type="text" class="form-control" id="last-name" placeholder="Last Name" required>
          </div>
        </div>
        <!-- Email -->
        <div class="mb-3 position-relative">
          <i class="bi bi-person input-icon"></i>
          <input type="email" class="form-control" id="signup-email" placeholder="Email-Address" required>
          <div class="invalid-feedback">Please provide a valid email.</div>
        </div>
        <!-- Password -->
        <div class="mb-3 password-container" onclick="focusPassword('signup-password')">
          <i class="bi bi-shield-lock input-icon"></i>
          <input type="password" class="form-control" id="signup-password" placeholder="Password" required>
          <i class="bi bi-eye" id="toggleSignupPassword"></i>
          <div class="invalid-feedback">Please provide a password.</div>
        </div>
        <!-- Confirm Password -->
        <div class="mb-3 password-container" onclick="focusPassword('confirm-password')">
          <i class="bi bi-shield-lock input-icon"></i>
          <input type="password" class="form-control" id="confirm-password" placeholder="Confirm Password" required>
          <i class="bi bi-eye" id="toggleConfirmPassword"></i>
          <div class="invalid-feedback">Passwords do not match.</div>
        </div>
        <!-- Verification Code (Send Code button is now smaller) -->
        <div class="mb-3">
          <div class="code-input-container">
            <div class="position-relative flex-grow-1">
              <i class="bi bi-key input-icon"></i>
              <input type="text" class="form-control" id="signup-code" placeholder="Enter Code" required>
              <div class="invalid-feedback">Please provide a code.</div>
            </div>
            <!-- Decreased size using btn-sm -->
            <button type="button" class="btn btn-primary btn-sm" id="send-code-btn" onclick="sendCode()">Send Code</button>
          </div>
          <span id="code-timer" class="code-timer"></span>
        </div>
        <button type="submit" class="btn btn-primary w-100 mt-1">Sign Up</button>
      </form>
      <button type="button" class="btn btn-link mt-1" onclick="toggleForm('login')">Log In</button>
    </div>
    
    <!-- Login Container -->
    <div class="container-custom fade-in" id="login-container" style="display: none;">
      <div class="app-name">TEDPOLE</div>
      <form id="login-form" class="needs-validation" novalidate>
        <div class="mb-3 position-relative">
          <i class="bi bi-person input-icon"></i>
          <input type="email" class="form-control" id="login-email" placeholder="Email-Address" required>
          <div class="invalid-feedback">Please provide a valid email.</div>
        </div>
        <div class="mb-3 password-container" onclick="focusPassword('login-password')">
          <i class="bi bi-shield-lock input-icon"></i>
          <input type="password" class="form-control" id="login-password" placeholder="Password" required>
          <i class="bi bi-eye" id="toggleLoginPassword"></i>
          <div class="invalid-feedback">Please provide a password.</div>
        </div>
        <button type="submit" class="btn btn-primary w-100">Log In</button>
      </form>
      <div class="d-flex justify-content-between mt-1">
        <a href="#" class="toggle-link" onclick="toggleForm('forgot')">Forgot Password!</a>
        <a href="#" class="toggle-link" onclick="toggleForm('signup')">Sign Up</a>
      </div>
    </div>
    
    <!-- Forgot Password Container -->
    <div class="container-custom fade-in" id="forgot-container" style="display: none;">
      <div class="app-name">TEDPOLE</div>
      <form id="forgot-form" class="needs-validation" novalidate>
        <div class="mb-3 position-relative">
          <i class="bi bi-person input-icon"></i>
          <input type="email" class="form-control" id="forgot-email" placeholder="Email-Address" required>
          <div class="invalid-feedback">Please provide a valid email.</div>
        </div>
        <button type="submit" class="btn btn-primary w-100">Reset Password</button>
      </form>
      <div class="d-flex justify-content-between mt-1">
        <a href="#" class="toggle-link" onclick="toggleForm('login')">Back to Login</a>
        <a href="#" class="toggle-link" onclick="toggleForm('signup')">Sign Up</a>
      </div>
    </div>
  </div>

  <!-- Welcome Message -->
  <div id="welcome">
    <div>
      <h1>TEDPOLE</h1>
      <!-- Example new logo if needed -->
      <!-- <img src="my-new-logo.png" alt="My New Logo" style="max-width: 150px; margin-top: 10px;"> -->
    </div>
  </div>

  <!-- Main App Content -->
  <div id="appContent">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm sticky-top">
      <div class="container">
        <a class="navbar-brand fw-bold" href="#" onclick="openFeatures()">TEDPOLE</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <!-- Removed the 'Home' link from the navbar as requested -->
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                <i class="bi bi-person-circle"></i>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                <li>
                  <!-- Clicking 'My Profile' now shows first & last name + email -->
                  <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#accountModal">
                    <i class="bi bi-person-badge"></i> My Profile (<span id="user-email"></span>)
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="#" data-bs-toggle="offcanvas" data-bs-target="#settingsOffcanvas">
                    <i class="bi bi-gear"></i> Settings
                  </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <a class="dropdown-item" href="#" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i> Logout
                  </a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Offcanvas for Settings -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="settingsOffcanvas">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title">Settings</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
      </div>
      <div class="offcanvas-body">
        <h6>Privacy</h6>
        <p>Manage your personal info.</p>
        <h6>Notifications</h6>
        <p>Control your notification settings.</p>
      </div>
    </div>

    <!-- Account Modal -->
    <div class="modal fade" id="accountModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Account Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <!-- Show first & last name, email, and placeholders for more credentials -->
            <p><strong>Full Name:</strong> <span id="account-full-name"></span></p>
            <p><strong>Email:</strong> <span id="account-email-display"></span></p>
            <hr/>
            <h6>Additional Credentials</h6>
            <p><em>Here you could allow the user to set more profile info, etc.</em></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Features Section -->
    <section class="py-5" id="features">
      <div class="container">
        <h2 class="text-center mb-4">Features</h2>
        <div class="row g-4">
          <!-- Capture Moments Card -->
          <div class="col-md-6">
            <div class="card shadow feature-card">
              <div class="card-body text-center">
                <i class="bi bi-camera2 display-4 text-primary"></i>
                <h4 class="mt-3">Capture Moments</h4>
                <p>Use advanced camera features with filters and brightness controls.</p>
                <a href="#camera" class="btn btn-primary" onclick="openCamera()">Open Camera</a>
              </div>
            </div>
          </div>
          <!-- Connect with Friends Card -->
          <div class="col-md-6">
            <div class="card shadow feature-card">
              <div class="card-body text-center">
                <i class="bi bi-chat-dots display-4 text-primary"></i>
                <h4 class="mt-3">Connect with Friends</h4>
                <p>View chats from invited contacts and interact seamlessly.</p>
                <a href="#chat" class="btn btn-primary" onclick="openChat()">Connect Now</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Camera Section -->
    <section id="camera">
      <div class="return-button" onclick="closeCamera()">
        <i class="bi bi-arrow-left-circle-fill"></i>
      </div>
      <h2 class="text-center text-white">Camera Feature</h2>
      <video id="camera-preview" autoplay></video>
      <div class="text-center mt-3">
        <label for="camera-filter" class="form-label text-white">Select Filter:</label>
        <select id="camera-filter" class="form-select d-inline-block" style="max-width: 200px;">
          <option value="none" selected>No Filter</option>
          <option value="grayscale(100%)">Grayscale</option>
          <option value="sepia(100%)">Sepia</option>
          <option value="invert(100%)">Invert</option>
          <option value="contrast(200%)">High Contrast</option>
        </select>
        <button class="btn btn-secondary ms-2" onclick="updateCameraFilter()">Apply Filter</button>
      </div>
      <div class="text-center mt-3">
        <button class="btn btn-info me-2" onclick="switchCamera()">Switch Camera</button>
      </div>
      <div class="text-center mt-4">
        <div class="capture-button" id="capture-photo" title="Capture Photo">ðŸ“¸</div>
        <button id="record-video" class="btn btn-danger">Record Video</button>
        <button id="stop-video" class="btn btn-secondary" style="display: none;">Stop Recording</button>
      </div>
    </section>

    <!-- Chat Section -->
    <section id="chat">
      <!-- Chat List View -->
      <div id="chat-list-view">
        <h5 class="mb-3">Chats</h5>
        <!-- Simulated chat list items -->
        <div class="chat-list-item" onclick="openChatDetail('Kushal')">
          <strong>Kushal</strong><br>
          <small>Last message snippet...</small>
        </div>
        <div class="chat-list-item" onclick="openChatDetail('Alice')">
          <strong>Alice</strong><br>
          <small>Last message snippet...</small>
        </div>
      </div>

      <!-- Chat Detail View -->
      <div id="chat-detail-view" style="display: none;">
        <!-- Chat Detail Top Bar -->
        <div id="chat-detail-top-bar" class="d-flex justify-content-between align-items-center">
          <!-- Left side: Removed the "9 dots" icon. Only show back icon, avatar, name -->
          <div id="chat-detail-left" class="d-flex align-items-center">
            <i id="back-icon" class="bi bi-arrow-left-circle-fill ms-2" style="cursor:pointer;" onclick="closeChatDetail()"></i>
            <img id="opponent-avatar" src="https://i.ibb.co/sPfSFCB/user-avatar.png" alt="Avatar">
            <span id="opponent-name" class="ms-2">Opponent Name</span>
          </div>
          <!-- Right side: voice call, video call, more options -->
          <div id="chat-detail-right" class="d-flex align-items-center">
            <i id="voice-call" class="bi bi-telephone me-2" style="cursor:pointer;" title="Voice Call"></i>
            <i id="video-call" class="bi bi-camera-video me-2" style="cursor:pointer;" title="Video Call"></i>
            <i id="more-options" class="bi bi-grid" style="cursor:pointer;" title="More Options" onclick="toggleMoreOptions()"></i>
            <!-- More Options Popup -->
            <div id="moreOptionsMenu">
              <ul>
                <li onclick="clearChat()">Clear Chat</li>
                <li onclick="blockUser()">Block</li>
                <li onclick="otherOptions()">Other Options</li>
              </ul>
            </div>
          </div>
        </div>
        <!-- Chat Messages Container -->
        <div id="detail-chat-messages-container">
          <div id="no-messages-placeholder" style="display: none;">
            <img src="https://i.ibb.co/0XcY7NJ/dog-emoji.png" alt="Placeholder Emoji">
            <p class="mt-2">No messages here yet...</p>
            <p>Start the conversation!</p>
          </div>
          <div id="chat-messages"></div>
        </div>
        <!-- Chat Input Area -->
        <div id="chat-input-area">
          <div class="input-group">
            <!-- Attachment Button (Plus Icon) -->
            <button class="btn btn-outline-secondary" type="button" onclick="toggleAttachMenu()">
              <i class="bi bi-plus-circle"></i>
            </button>
            <input type="text" id="chat-input-detail" class="form-control" placeholder="Type a message..." />
            <!-- Send Button (Send Icon) -->
            <button class="btn btn-primary" id="send-chat-detail-btn" type="button">
              <i class="bi bi-send"></i>
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Attachment Menu Popup -->
    <div class="attach-menu" id="attachMenu">
      <ul>
        <li onclick="attachFile('file')"><i class="bi bi-file-earmark"></i> File</li>
        <li onclick="attachFile('image')"><i class="bi bi-image"></i> Image</li>
        <li onclick="attachFile('document')"><i class="bi bi-file-earmark-text"></i> Document</li>
      </ul>
    </div>

    <!-- Footer -->
    <footer class="py-4">
      <div class="container text-center">
      </div>
    </footer>
  </div>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* --------------------- Global & Authentication Logic --------------------- */
    const authSection       = document.getElementById('auth-section');
    const signupContainer   = document.getElementById('signup-container');
    const loginContainer    = document.getElementById('login-container');
    const forgotContainer   = document.getElementById('forgot-container');
    const welcome           = document.getElementById('welcome');
    const appContent        = document.getElementById('appContent');
    const userEmailEl       = document.getElementById('user-email');

    const signupForm        = document.getElementById('signup-form');
    const loginForm         = document.getElementById('login-form');
    const forgotForm        = document.getElementById('forgot-form');
    const firstNameInput    = document.getElementById('first-name');
    const lastNameInput     = document.getElementById('last-name');
    const signupEmail       = document.getElementById('signup-email');
    const loginEmail        = document.getElementById('login-email');
    const forgotEmail       = document.getElementById('forgot-email');
    const signupPassword    = document.getElementById('signup-password');
    const loginPassword     = document.getElementById('login-password');
    const confirmPassword   = document.getElementById('confirm-password');
    const signupCodeInput   = document.getElementById('signup-code');
    const codeTimer         = document.getElementById('code-timer');
    const sendCodeBtn       = document.getElementById('send-code-btn');

    // For displaying first & last name in the account modal
    const accountFullNameEl = document.getElementById('account-full-name');
    const accountEmailEl    = document.getElementById('account-email-display');

    let verificationCode, timerInterval;
    let loggedInUserEmail = '';
    let loggedInUserFirstName = '';
    let loggedInUserLastName  = '';

    function toggleForm(form) {
      signupContainer.classList.remove('fade-in');
      loginContainer.classList.remove('fade-in');
      forgotContainer.classList.remove('fade-in');
      if(form === 'login'){
        signupContainer.style.display = 'none';
        forgotContainer.style.display = 'none';
        loginContainer.style.display = 'block';
        loginContainer.classList.add('fade-in');
      } else if (form === 'signup'){
        loginContainer.style.display = 'none';
        forgotContainer.style.display = 'none';
        signupContainer.style.display = 'block';
        signupContainer.classList.add('fade-in');
      } else if (form === 'forgot'){
        loginContainer.style.display = 'none';
        signupContainer.style.display = 'none';
        forgotContainer.style.display = 'block';
        forgotContainer.classList.add('fade-in');
      }
    }

    /* Sign Up */
    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!signupForm.checkValidity()) {
        e.stopPropagation();
        signupForm.classList.add('was-validated');
        return;
      }
      const firstName = firstNameInput.value.trim();
      const lastName  = lastNameInput.value.trim();
      const email     = signupEmail.value.trim();
      const password  = signupPassword.value;
      const confirm   = confirmPassword.value;
      const code      = signupCodeInput.value.trim();

      if (password !== confirm) {
        alert('Passwords do not match');
        return;
      }
      if (code != verificationCode) {
        alert('Invalid verification code');
        return;
      }
      try {
        // In real logic, you'd also send firstName & lastName to the server
        await fetch('http://localhost:3000/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ firstName, lastName, email, password })
        });
      } catch (error) {
        console.error('Signup Error:', error);
      } finally {
        loggedInUserFirstName = firstName;
        loggedInUserLastName  = lastName;
        loggedInUserEmail     = email;
        userEmailEl.textContent = loggedInUserEmail;
        // Show the welcome screen
        authSection.style.display = 'none';
        welcome.style.display = 'flex';
        setTimeout(() => {
          welcome.style.display = 'none';
          appContent.style.display = 'block';
          // Update account modal info
          accountFullNameEl.textContent = `${loggedInUserFirstName} ${loggedInUserLastName}`;
          accountEmailEl.textContent    = loggedInUserEmail;
        }, 2000);
      }
    });

    /* Login */
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!loginForm.checkValidity()) {
        e.stopPropagation();
        loginForm.classList.add('was-validated');
        return;
      }
      const email    = loginEmail.value.trim();
      const password = loginPassword.value;
      try {
        // Suppose the server returns firstName & lastName after login
        const response = await fetch('http://localhost:3000/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        // Example: { firstName: 'John', lastName: 'Doe', message: 'Login successful' }
        const data = await response.json();
        loggedInUserFirstName = data.firstName || 'NoFirstName';
        loggedInUserLastName  = data.lastName  || 'NoLastName';
      } catch (error) {
        console.error('Login Error:', error);
      } finally {
        loggedInUserEmail = email;
        userEmailEl.textContent = loggedInUserEmail;
        authSection.style.display = 'none';
        welcome.style.display = 'flex';
        setTimeout(() => {
          welcome.style.display = 'none';
          appContent.style.display = 'block';
          // Update account modal info
          accountFullNameEl.textContent = `${loggedInUserFirstName} ${loggedInUserLastName}`;
          accountEmailEl.textContent    = loggedInUserEmail;
        }, 2000);
      }
    });

    /* Forgot Password */
    forgotForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!forgotForm.checkValidity()) {
        e.stopPropagation();
        forgotForm.classList.add('was-validated');
        return;
      }
      const email = forgotEmail.value.trim();
      try {
        const response = await fetch('http://localhost:3000/forgot-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const data = await response.json();
        alert(data.message);
        toggleForm('login');
      } catch (error) {
        console.error('Forgot Password Error:', error);
        alert('Reset password request failed.');
      }
    });

    /* Generate & Send Code */
    function generateCode() {
      return Math.floor(100000 + Math.random() * 900000);
    }
    function sendCode() {
      const email = signupEmail.value.trim();
      if (!email) {
        alert('Please enter your email first.');
        return;
      }
      verificationCode = generateCode();
      alert(`Verification code sent to ${email}: ${verificationCode}`);
      startTimer();
      sendCodeBtn.disabled = true;
    }
    function startTimer() {
      let timeLeft = 60;
      codeTimer.textContent = `00:${timeLeft < 10 ? '0' : ''}${timeLeft}`;
      timerInterval = setInterval(() => {
        timeLeft--;
        codeTimer.textContent = timeLeft >= 0 ? `00:${timeLeft < 10 ? '0' : ''}${timeLeft}` : "Time's up!";
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          sendCodeBtn.disabled = false;
        }
      }, 1000);
    }

    /* Password Visibility Toggles */
    const toggleSignupPassword   = document.getElementById('toggleSignupPassword');
    const toggleLoginPassword    = document.getElementById('toggleLoginPassword');
    const toggleConfirmPassword  = document.getElementById('toggleConfirmPassword');
    toggleSignupPassword.addEventListener('click', () => {
      const type = signupPassword.getAttribute('type') === 'password' ? 'text' : 'password';
      signupPassword.setAttribute('type', type);
      toggleSignupPassword.classList.toggle('bi-eye-slash');
    });
    toggleLoginPassword.addEventListener('click', () => {
      const type = loginPassword.getAttribute('type') === 'password' ? 'text' : 'password';
      loginPassword.setAttribute('type', type);
      toggleLoginPassword.classList.toggle('bi-eye-slash');
    });
    toggleConfirmPassword.addEventListener('click', () => {
      const type = confirmPassword.getAttribute('type') === 'password' ? 'text' : 'password';
      confirmPassword.setAttribute('type', type);
      toggleConfirmPassword.classList.toggle('bi-eye-slash');
    });
    function focusPassword(id) {
      document.getElementById(id).focus();
    }

    /* Logout */
    function logout() {
      loggedInUserEmail      = '';
      loggedInUserFirstName  = '';
      loggedInUserLastName   = '';
      userEmailEl.textContent = '';
      authSection.style.display = 'flex';
      appContent.style.display = 'none';
      alert('Logged out successfully.');
    }

    /* Navigation: openFeatures, openCamera, openChat, etc. */
    function openFeatures() {
      document.getElementById('features').style.display = 'block';
      document.getElementById('camera').style.display   = 'none';
      document.getElementById('chat').style.display     = 'none';
    }

    /* --------------------- Camera Feature --------------------- */
    const cameraPreview      = document.getElementById('camera-preview');
    const capturePhotoButton = document.getElementById('capture-photo');
    const recordVideoButton  = document.getElementById('record-video');
    const stopVideoButton    = document.getElementById('stop-video');
    const cameraFilterSelect = document.getElementById('camera-filter');
    const brightnessSlider   = document.getElementById('brightness-slider');
    let camStream, camRecorder, camRecordedChunks = [];
    let currentFacingMode = "user";

    async function openCamera() {
      document.getElementById('features').style.display = 'none';
      document.getElementById('chat').style.display     = 'none';
      document.getElementById('camera').style.display   = 'block';
      try {
        camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode }, audio: true });
        cameraPreview.srcObject = camStream;
      } catch (error) {
        console.error('Error accessing camera/microphone:', error);
        alert('Cannot access camera and microphone.');
      }
    }
    capturePhotoButton.addEventListener('click', () => {
      const canvas = document.createElement('canvas');
      canvas.width = cameraPreview.videoWidth;
      canvas.height = cameraPreview.videoHeight;
      const context = canvas.getContext('2d');
      context.filter = cameraPreview.style.filter;
      context.drawImage(cameraPreview, 0, 0, canvas.width, canvas.height);
      const imageUrl = canvas.toDataURL('image/png');
      const link = document.createElement('a');
      link.href = imageUrl;
      link.download = 'photo.png';
      link.click();
    });
    recordVideoButton.addEventListener('click', () => {
      camRecordedChunks = [];
      try {
        camRecorder = new MediaRecorder(camStream, { mimeType: 'video/webm' });
      } catch (e) {
        console.error('MediaRecorder not supported', e);
        alert('Video recording is not supported in this browser.');
        return;
      }
      camRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) camRecordedChunks.push(event.data);
      };
      camRecorder.onstop = () => {
        const blob = new Blob(camRecordedChunks, { type: 'video/webm' });
        const videoUrl = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = videoUrl;
        link.download = 'video.webm';
        link.click();
      };
      camRecorder.start();
      recordVideoButton.style.display = 'none';
      stopVideoButton.style.display = 'block';
    });
    stopVideoButton.addEventListener('click', () => {
      if(camRecorder && camRecorder.state !== 'inactive') {
        camRecorder.stop();
      }
      recordVideoButton.style.display = 'block';
      stopVideoButton.style.display = 'none';
    });
    function closeCamera() {
      if (camStream) {
        camStream.getTracks().forEach(track => track.stop());
      }
      document.getElementById('camera').style.display   = 'none';
      document.getElementById('features').style.display = 'block';
    }
    function updateCameraFilter() {
      const filterValue = cameraFilterSelect.value;
      const brightnessValue = brightnessSlider?.value || 100;
      let filterString = "";
      if (filterValue !== "none") {
        filterString += filterValue + " ";
      }
      filterString += `brightness(${brightnessValue}%)`;
      cameraPreview.style.filter = filterString;
    }
    brightnessSlider?.addEventListener('input', updateCameraFilter);
    async function switchCamera() {
      currentFacingMode = currentFacingMode === "user" ? "environment" : "user";
      if (camStream) {
        camStream.getTracks().forEach(track => track.stop());
      }
      try {
        camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode }, audio: true });
        cameraPreview.srcObject = camStream;
      } catch (error) {
        console.error('Error switching camera:', error);
        alert('Unable to switch camera.');
      }
    }

    /* --------------------- Chat Section --------------------- */
    const chatListView   = document.getElementById('chat-list-view');
    const chatDetailView = document.getElementById('chat-detail-view');

    let chatList = [
      { name: "Kushal" },
      { name: "Alice" }
    ];
    function renderChatList() {
      chatListView.innerHTML = "<h5 class='mb-3'>Chats</h5>";
      chatList.forEach(chat => {
        let div = document.createElement('div');
        div.className = 'chat-list-item';
        div.innerHTML = `<strong>${chat.name}</strong><br><small>Last message snippet...</small>`;
        div.onclick = () => openChatDetail(chat.name);
        chatListView.appendChild(div);
      });
    }
    function openChat() {
      document.getElementById('features').style.display = 'none';
      document.getElementById('camera').style.display   = 'none';
      document.getElementById('chat').style.display     = 'block';
      chatListView.style.display                        = 'block';
      chatDetailView.style.display                      = 'none';
      renderChatList();
    }
    function closeChat() {
      document.getElementById('chat').style.display     = 'none';
      document.getElementById('features').style.display = 'block';
    }
    // Chat Detail
    function openChatDetail(contactName) {
      document.getElementById('opponent-name').textContent = contactName;
      chatListView.style.display = 'none';
      chatDetailView.style.display = 'block';
      document.getElementById('chat-messages').innerHTML = "";
      document.getElementById('no-messages-placeholder').style.display = 'block';
    }
    function closeChatDetail() {
      chatDetailView.style.display = 'none';
      chatListView.style.display   = 'block';
    }
    // More Options
    function toggleMoreOptions() {
      const moreOptionsMenu = document.getElementById('moreOptionsMenu');
      if(moreOptionsMenu.style.display === 'none' || moreOptionsMenu.style.display === ''){
        moreOptionsMenu.style.display = 'block';
      } else {
        moreOptionsMenu.style.display = 'none';
      }
    }
    function clearChat() {
      if(confirm("Clear all messages?")) {
        document.getElementById('chat-messages').innerHTML = "";
        document.getElementById('no-messages-placeholder').style.display = 'block';
      }
      toggleMoreOptions();
    }
    function blockUser() {
      alert("User blocked.");
      toggleMoreOptions();
    }
    function otherOptions() {
      alert("Other options.");
      toggleMoreOptions();
    }
    // Sending Messages
    const chatMessages      = document.getElementById('chat-messages');
    const chatInputDetail   = document.getElementById('chat-input-detail');
    const sendChatDetailBtn = document.getElementById('send-chat-detail-btn');
    sendChatDetailBtn.addEventListener('click', sendChatDetailMessage);
    chatInputDetail.addEventListener('keypress', (e) => {
      if(e.key === 'Enter') sendChatDetailMessage();
    });
    function sendChatDetailMessage() {
      const message = chatInputDetail.value.trim();
      if(!message) return;
      chatInputDetail.value = "";
      const messageElement = document.createElement('div');
      messageElement.className = 'chat-message';
      messageElement.textContent = `${loggedInUserEmail || 'You'}: ${message}`;
      chatMessages.appendChild(messageElement);
      document.getElementById('no-messages-placeholder').style.display = 'none';
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    // Attachment Menu
    const attachMenu = document.getElementById('attachMenu');
    function toggleAttachMenu() {
      if(attachMenu.style.display === 'none' || attachMenu.style.display === '') {
        attachMenu.style.display = 'block';
      } else {
        attachMenu.style.display = 'none';
      }
    }
    function attachFile(type) {
      alert(`Attach a ${type}. (File picker would open here.)`);
      attachMenu.style.display = 'none';
    }
  </script>
  
  <!-- More Options Popup for Chat Detail -->
  <div id="moreOptionsMenu">
    <ul>
      <li onclick="clearChat()">Clear Chat</li>
      <li onclick="blockUser()">Block</li>
      <li onclick="otherOptions()">Other Options</li>
    </ul>
  </div>
</body>
</html>
